== CIPipeline CRD Definition

This CRD defines the desired state of a CI pipeline for containerized web services running on Kubernetes. It is designed to be highly extensible, support any container build process, and always produce a deployable container image. The artifact can be pushed to any registry (Harbor, ECR, GitHub, etc.). Manifests using this CRD will be generated by a web UI templater that prompts for the source code repository URI and other configuration options.

[source,yaml]
----
apiVersion: apiextensions.k8s.io/v1                           // <1>
kind: CustomResourceDefinition                             // <2>
metadata:
  name: cipipelines.ci.example.com                         // <3>
spec:
  group: ci.example.com                                    // <4>
  scope: Namespaced                                        // <5>
  names:
    plural: cipipelines                                    // <6>
    singular: cipipeline                                   // <7>
    kind: CIPipeline                                       // <8>
    shortNames:
      - cip
  versions:
    - name: v1alpha1                                       // <9>
      served: true                                         // <10>
      storage: true                                        // <11>
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                source:                                   // <12>
                  type: object
                  description: "Configuration of the source code repository."  // <13>
                  properties:
                    repoURI:
                      type: string
                      description: "URI of the source code repository."           // <14>
                    branch:
                      type: string
                      description: "Branch to be built (e.g., main, develop)."      // <15>
                    credentials:
                      type: object
                      description: "Reference to a Kubernetes Secret for repository access." // <16>
                      properties:
                        secretName:
                          type: string
                        secretKey:
                          type: string
                  required:
                    - repoURI
                triggers:                                 // <17>
                  type: object
                  description: "Configuration for pipeline triggers."             // <18>
                  properties:
                    type:
                      type: string
                      enum: ["webhook", "schedule", "manual"]
                      description: "Trigger type for pipeline execution."           // <19>
                    schedule:
                      type: string
                      description: "Cron expression for scheduled triggers (if applicable)." // <20>
                    webhook:
                      type: object
                      description: "Settings for webhook-based triggers."           // <21>
                      properties:
                        endpoint:
                          type: string
                          description: "Webhook endpoint URL."                    // <22>
                        secret:
                          type: string
                          description: "Secret used to validate webhook payloads."    // <23>
                  required:
                    - type
                stages:                                   // <24>
                  type: array
                  description: "An ordered list of pipeline stages."               // <25>
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                        description: "Unique name for the stage (e.g., build, test, deploy)." // <26>
                      type:
                        type: string
                        enum: ["build", "test", "deploy", "custom"]
                        description: "Type of stage."                              // <27>
                      buildSpec:
                        type: object
                        description: "Parameters for building a container image."    // <28>
                        properties:
                          dockerfile:
                            type: string
                            description: "Path to the Dockerfile."                  // <29>
                          buildContext:
                            type: string
                            description: "Directory for the build context."         // <30>
                          buildArgs:
                            type: object
                            description: "Key/value pairs for build arguments."     // <31>
                      jobSpec:
                        type: object
                        description: "Kubernetes Job spec to execute this stage."     // <32>
                        properties:
                          image:
                            type: string
                            description: "Container image used to run the job."       // <33>
                          command:
                            type: array
                            items:
                              type: string
                            description: "Command to execute in the container."       // <34>
                          args:
                            type: array
                            items:
                              type: string
                            description: "Arguments for the command."                 // <35>
                          env:
                            type: array
                            items:
                              type: object
                              properties:
                                name:
                                  type: string
                                value:
                                  type: string
                            description: "Environment variables for the job."           // <36>
                      customConfig:
                        type: object
                        description: "Tool-specific configuration (e.g., Tekton, Jenkins)." // <37>
                        x-kubernetes-preserve-unknown-fields: true
                    required:
                      - name
                      - type
                  minItems: 1
                artifacts:                                // <38>
                  type: object
                  description: "Details of the deployable artifact produced by the pipeline." // <39>
                  properties:
                    type:
                      type: string
                      enum: ["container-image"]
                      description: "Artifact type. Currently, only container-image is supported." // <40>
                    destination:
                      type: object
                      description: "Registry or storage details for pushing the artifact." // <41>
                      properties:
                        registry:
                          type: string
                          description: "Registry URL (e.g., harbor.example.com, ecr.aws-region.amazonaws.com)." // <42>
                        repository:
                          type: string
                          description: "Name of the repository in the registry."    // <43>
                        tag:
                          type: string
                          description: "Tag for the container image."                // <44>
                        credentials:
                          type: object
                          description: "Reference to a Kubernetes Secret for registry authentication." // <45>
                          properties:
                            secretName:
                              type: string
                            secretKey:
                              type: string
                  required:
                    - type
                    - destination
                notifications:                          // <46>
                  type: array
                  description: "Notification configurations for pipeline events."  // <47>
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        enum: ["slack", "email", "webhook"]
                        description: "Notification channel type."                // <48>
                      slack:
                        type: object
                        description: "Slack notification settings."              // <49>
                        properties:
                          webhookURL:
                            type: string
                      email:
                        type: object
                        description: "Email notification settings."                // <50>
                        properties:
                          addresses:
                            type: array
                            items:
                              type: string
                      webhook:
                        type: object
                        description: "Generic webhook notification settings."      // <51>
                        properties:
                          url:
                            type: string
                          secret:
                            type: string
                environments:                             // <52>
                  type: object
                  description: "Additional environment settings for deployment or testing." // <53>
                  properties:
                    variables:
                      type: array
                      description: "Key/value pairs for environment variables."  // <54>
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          value:
                            type: string
                    configMapRef:
                      type: object
                      description: "Reference to a ConfigMap for environment configuration." // <55>
                      properties:
                        name:
                          type: string
                    secretRef:
                      type: object
                      description: "Reference to a Secret for sensitive configurations." // <56>
                      properties:
                        name:
                          type: string
              required:
                - source
                - triggers
                - stages
                - artifacts
      subresources:
        status: {}                                           // <57>
----
<1> API version for CRD creation.
<2> Declares the resource as a CustomResourceDefinition.
<3> Unique name for the CRD.
<4> API group to which the CRD belongs.
<5> Namespaced scope indicates that the resource exists within a specific namespace.
<6>-<8> Naming conventions for singular, plural, and kind.
<9>-<11> Versioning information (v1alpha1 is both served and stored).
<12>-<15> "source" section defines repository details including repo URI, branch, and optional credentials.
<16> Credentials are used to securely access private repositories.
<17>-<23> "triggers" section configures how the pipeline is initiated (webhook, schedule, or manual).
<24>-<27> "stages" array represents sequential pipeline stages with a unique name and type.
<28>-<31> "buildSpec" within each stage provides container build details (Dockerfile path, context, build args).
<32>-<36> "jobSpec" provides a Kubernetes Job-like configuration to run the stage.
<37> "customConfig" allows extensibility for tool-specific settings.
<38>-<45> "artifacts" section mandates that a container-image artifact is produced and defines destination details for pushing the artifact to any registry.
<46>-<51> "notifications" section configures alerts (Slack, email, webhook) for pipeline events.
<52>-<56> "environments" section allows the injection of environment variables and references to ConfigMaps/Secrets.
<57> Enables the status subresource for tracking pipeline state.
== End of CIPipeline CRD Definition
