```markdown
Task: Create a Kubernetes Custom Resource Definition (CRD) for a CI Pipeline.  

Context:  
As a Kubernetes expert, design a CRD that defines a Continuous Integration (CI) pipeline for a containerized web service. This CRD should ensure:  
- The pipeline builds and pushes images only after successful validation checks.  
- Deployment is **not** handled by this pipeline (managed separately by a CD pipeline).  

### Requirements:  
1. **Defining the Pipeline**  
   - Specify which CI system will be used (Jenkins, GitHub Actions, GitLab CI, etc.).  
   - Allow pre-build validation steps:  
     - Code review enforcement  
     - Security scanning (Gitleaks, SAST)  
     - Secrets scanning  

2. **CRD Structure**  
   - Define key fields representing the CI pipeline state.  
   - Integrate with Kubernetes-native resources (e.g., ConfigMaps, Secrets).  

3. **Customization & Security**  
   - Support user-defined shell commands and container execution for custom steps.  
   - Provide flexible container tagging strategies (commit-based, SemVer).  
   - Retrieve registry credentials securely via external-secrets-operator.  

4. **Deliverables**  
   - A detailed CRD schema.  
   - Example CR manifests:  
     - A standard pipeline  
     - A highly customized pipeline with additional security layers  

### Key Considerations:  
- The CRD should be flexible and compatible with diverse CI workflows.  
- Follow Kubernetes best practices for extensibility and security.  
- Document assumptions and expected behaviors in example manifests.  
```

Below is one approach to designing a Kubernetes CRD that represents a CI pipeline for a containerized web service. In this design, the pipeline is responsible for building and pushing images **only after** passing a series of validation steps (code review, security scanning, and secrets scanning). Note that deployment is purposefully omitted (handled separately by a CD pipeline). The CRD is designed to be flexible, Kubernetes-native, and extensible for different CI systems and workflows.

---

## 1. CRD Schema

The following YAML defines the CRD, detailing the key fields that capture the desired state of a CI pipeline. We break the configuration into several sections:

- **ciSystem & triggers:** Specify the CI engine (Jenkins, GitHub Actions, GitLab CI, etc.) and the event-based triggers for starting the pipeline.
- **validations:** Define pre-build checks such as code review enforcement, static security scanning (SAST), and secrets detection.
- **customSteps:** Allow users to inject custom automation via shell commands or containerized steps.
- **stages:** Organize the pipeline into ordered stages (e.g., build, push) where each stage comprises one or more execution steps.
- **build:** Configure how the container image is built, including Dockerfile location, build context, and the container tagging strategy (commit-based, SemVer, or custom).
- **registry:** Provide details for pushing the built image, with a secure reference to registry credentials (e.g., via an external-secrets-operator).
- **notifications:** Optionally define how to notify external systems (via webhook or email) upon pipeline events.

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: cipipelines.ci.example.com
spec:
  group: ci.example.com
  names:
    kind: CIPipeline
    plural: cipipelines
    singular: cipipeline
    shortNames:
      - cip
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                # Which CI system is in use.
                ciSystem:
                  type: string
                  description: "The CI system (e.g., Jenkins, GitHub Actions, GitLab CI)."
                # Event-based triggers for starting the pipeline.
                triggers:
                  type: object
                  description: "Configuration for event-based triggers."
                  properties:
                    event:
                      type: string
                      description: "Event type that triggers the pipeline (e.g., push, pull_request)."
                    branch:
                      type: string
                      description: "Branch filter for triggering the pipeline (e.g., main, develop)."
                # Pre-build validation steps to enforce quality and security.
                validations:
                  type: object
                  description: "Pre-build validation checks."
                  properties:
                    codeReview:
                      type: object
                      description: "Code review enforcement settings."
                      properties:
                        required:
                          type: boolean
                          description: "Whether code review is mandatory."
                        reviewers:
                          type: array
                          items:
                            type: string
                          description: "Optional list of designated reviewers."
                    securityScanning:
                      type: object
                      description: "Static Application Security Testing (SAST) configuration."
                      properties:
                        enabled:
                          type: boolean
                          description: "Enable SAST."
                        tool:
                          type: string
                          description: "Name of the SAST tool (e.g., CodeQL, SonarQube)."
                    secretsScanning:
                      type: object
                      description: "Secrets detection configuration."
                      properties:
                        enabled:
                          type: boolean
                          description: "Enable secrets scanning (e.g., Gitleaks)."
                        tool:
                          type: string
                          description: "Name of the secrets scanning tool."
                # Custom steps allow users to extend the pipeline with their own commands.
                customSteps:
                  type: array
                  description: "Optional custom execution steps for additional automation."
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                        description: "Name of the custom step."
                      type:
                        type: string
                        enum: ["shell", "container"]
                        description: "Execution type: 'shell' for command-line or 'container' for containerized execution."
                      command:
                        type: string
                        description: "Shell command to execute (if applicable)."
                      image:
                        type: string
                        description: "Container image to execute (if applicable)."
                      args:
                        type: array
                        items:
                          type: string
                        description: "Arguments for the container command."
                # Stages represent the ordered steps of the pipeline.
                stages:
                  type: array
                  description: "Pipeline stages; each stage contains one or more steps."
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                        description: "Name of the stage."
                      steps:
                        type: array
                        description: "List of steps within the stage."
                        items:
                          type: object
                          properties:
                            name:
                              type: string
                              description: "Step name."
                            type:
                              type: string
                              enum: ["shell", "container"]
                              description: "Execution type of the step."
                            command:
                              type: string
                              description: "Shell command (if type is 'shell')."
                            image:
                              type: string
                              description: "Container image (if type is 'container')."
                            args:
                              type: array
                              items:
                                type: string
                              description: "Arguments for the container."
                # Build configuration for the image.
                build:
                  type: object
                  description: "Configuration for building the container image."
                  properties:
                    dockerfile:
                      type: string
                      description: "Path to the Dockerfile."
                    context:
                      type: string
                      description: "Build context directory."
                    taggingStrategy:
                      type: string
                      enum: ["commit", "semver", "custom"]
                      description: "Strategy for tagging the image (commit-based, semantic versioning, or custom)."
                    customTag:
                      type: string
                      description: "Custom tag value if 'custom' strategy is used."
                # Registry configuration and secure credential retrieval.
                registry:
                  type: object
                  description: "Container registry settings for pushing the image."
                  properties:
                    url:
                      type: string
                      description: "Container registry URL."
                    repository:
                      type: string
                      description: "Repository name within the registry."
                    credentialsRef:
                      type: object
                      description: "Reference to a Secret or external secret for registry credentials."
                      properties:
                        name:
                          type: string
                        key:
                          type: string
                # Notification configuration for pipeline events.
                notifications:
                  type: object
                  description: "Configuration for notifications (e.g., webhook, email)."
                  properties:
                    webhook:
                      type: string
                      description: "Webhook URL for notifications."
                    email:
                      type: string
                      description: "Email address for notifications."
              required:
                - ciSystem
                - validations
                - stages
                - build
                - registry
      subresources:
        status: {}
```

---

## 2. Example CR Manifests

Below are two example manifests that demonstrate how this CRD might be used in practice.

### A. Standard CI Pipeline

A basic pipeline using GitHub Actions that builds and pushes an image after performing code review, security scanning, and secrets detection.

```yaml
apiVersion: ci.example.com/v1alpha1
kind: CIPipeline
metadata:
  name: standard-ci-pipeline
spec:
  ciSystem: "GitHub Actions"
  triggers:
    event: "push"
    branch: "main"
  validations:
    codeReview:
      required: true
    securityScanning:
      enabled: true
      tool: "SonarQube"
    secretsScanning:
      enabled: true
      tool: "Gitleaks"
  stages:
    - name: "Build Stage"
      steps:
        - name: "Build Image"
          type: "shell"
          command: "docker build -t myapp:$(git rev-parse --short HEAD) -f ./Dockerfile ."
    - name: "Push Stage"
      steps:
        - name: "Push Image"
          type: "shell"
          command: "docker push myapp:$(git rev-parse --short HEAD)"
  build:
    dockerfile: "./Dockerfile"
    context: "./"
    taggingStrategy: "commit"
  registry:
    url: "https://registry.example.com"
    repository: "myapp"
    credentialsRef:
      name: "registry-secret"
      key: "password"
  notifications:
    webhook: "https://hooks.example.com/ci"
```

**Assumptions & Behaviors:**

- **CI System & Triggers:** Uses GitHub Actions, triggered by pushes to the `main` branch.
- **Validations:** Enforces a code review and runs SonarQube for static analysis along with Gitleaks for secrets scanning.
- **Stages:** The pipeline consists of two stages: building the image and pushing it.
- **Registry Integration:** Registry credentials are securely referenced from a Kubernetes Secret.
- **Notifications:** A webhook is configured to notify external systems about pipeline events.

---

### B. Advanced CI Pipeline with Custom Security Layers

A highly customized pipeline using Jenkins with additional custom steps and more granular security checks.

```yaml
apiVersion: ci.example.com/v1alpha1
kind: CIPipeline
metadata:
  name: advanced-ci-pipeline
spec:
  ciSystem: "Jenkins"
  triggers:
    event: "pull_request"
    branch: "develop"
  validations:
    codeReview:
      required: true
      reviewers:
        - "alice"
        - "bob"
    securityScanning:
      enabled: true
      tool: "CodeQL"
    secretsScanning:
      enabled: true
      tool: "Gitleaks"
  customSteps:
    - name: "Custom Security Audit"
      type: "shell"
      command: "npm run audit"
  stages:
    - name: "Validation Stage"
      steps:
        - name: "Verify Code Review"
          type: "shell"
          command: "check-code-review --reviewers alice,bob"
        - name: "Run Secrets Scan"
          type: "shell"
          command: "gitleaks detect --source ."
        - name: "Static Analysis"
          type: "container"
          image: "codeql-analysis:latest"
          args: ["analyze", "./src"]
        - name: "Custom Security Audit"
          type: "shell"
          command: "npm run audit"
    - name: "Build Stage"
      steps:
        - name: "Build Container"
          type: "shell"
          command: "docker build -t webapp:$(git rev-parse --short HEAD) -f ./Dockerfile ."
    - name: "Push Stage"
      steps:
        - name: "Push Image"
          type: "shell"
          command: "docker push webapp:$(git rev-parse --short HEAD)"
  build:
    dockerfile: "./Dockerfile"
    context: "./"
    taggingStrategy: "semver"
  registry:
    url: "https://private.registry.com"
    repository: "webapp"
    credentialsRef:
      name: "private-registry-secret"
      key: "auth"
  notifications:
    webhook: "https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX"
    email: "devops@example.com"
```

**Assumptions & Behaviors:**

- **CI System & Triggers:** Configured for Jenkins, triggered on pull requests to the `develop` branch.
- **Validations:** Enforces code review (with a list of approved reviewers), runs CodeQL for SAST, and uses Gitleaks for secrets scanning.
- **Custom Steps:** Adds an extra security audit step (`npm run audit`) as a custom step.
- **Stages:** The pipeline is divided into three stages: validation, build, and push.
- **Build & Tagging:** Uses semantic versioning (`semver`) to tag the image.
- **Registry Integration & Notifications:** Securely pulls registry credentials and sends notifications via both Slack webhook and email.

---

## Final Thoughts

This CRD design provides a Kubernetes-native way to declaratively define your CI pipeline’s desired state. By separating validations, build processes, and notifications—and leveraging Kubernetes resources like Secrets—the design remains flexible and secure while accommodating a wide variety of CI workflows. You can extend or customize the schema further to match your specific operational requirements as your CI/CD ecosystem evolves.
